<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Planning & Report DCO Harian FG BM3</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; }
        .dashboard-container { max-width: 1500px; margin: auto; }
        .header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #ddd; }
        .header .logo { height: 50px; width: auto; }
        .header h1 { color: #2c3e50; margin: 0; font-size: 1.8em; flex-grow: 1; }
        .header .date-info { font-size: 1.1em; font-weight: bold; color: #34495e; white-space: nowrap; }
        .card { background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center; }
        .kpi-card { background-color: #3498db; color: white; padding: 20px; border-radius: 8px; }
        .kpi-card .value { font-size: 2.5em; font-weight: bold; }
        .kpi-card .label { font-size: 1.1em; margin-top: 5px; opacity: 0.9; }
        .kpi-card.new-plan { background-color: #2ecc71; }
        .kpi-card.tonase { background-color: #9b59b6; }
        .kpi-card.achievement { background-color: #e67e22; }
        .planning-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .planning-table th, .planning-table td { padding: 12px; text-align: center; border: 1px solid #ddd; vertical-align: middle; }
        .planning-table th { background-color: #f2f2f2; font-weight: bold; color: #34495e; }
        .planning-table td.customer, .planning-table td.dn-cell, .planning-table td.ekspedisi-cell { text-align: left; }
        .planning-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .planning-table tfoot { font-weight: bold; background-color: #eaf5ff; }
        .planning-table tfoot tr.calc-row td { color: #2980b9; font-size: 1.1em; }
        td[contenteditable="true"] { background-color: #ffffe0; cursor: pointer; }
        td[contenteditable="true"]:focus { background-color: #fff; outline: 2px solid #3498db; }
        .status-select { padding: 8px; border: 1px solid #aaa; border-radius: 4px; width: 100%; font-weight: bold; color: #333; transition: background-color 0.3s; }
        .status-muat { background-color: #f1c40f; }
        .status-otw { background-color: #2ecc71; color: white; }
        .action-buttons { margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px; }
        .action-buttons button { padding: 10px 20px; border: none; border-radius: 5px; color: white; font-size: 1em; cursor: pointer; }
        #btn-add-row { background-color: #3498db; }
        #btn-save { background-color: #27ae60; }
        .btn-delete { background-color: #e74c3c; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <header class="header">
            <img src="https://indahkiat.co.id/o/ikpp-theme/images/logo_indah_kiat.svg" alt="Logo Indah Kiat" class="logo">
            <h1>Dashboard Planning & Report DCO Harian FG BM3</h1>
            <div id="report-date" class="date-info" contenteditable="true">Menghubungkan ke database...</div>
        </header>

        <section class="kpi-grid">
            <div class="kpi-card">
                <div class="value" id="kpi-total-realisasi">0</div>
                <div class="label">Total Realisasi</div>
            </div>
            <div class="kpi-card new-plan">
                <div class="value" id="kpi-total-newplan">0</div>
                <div class="label">Total New Plan</div>
            </div>
            <div class="kpi-card tonase">
                <div class="value" id="kpi-total-tonplan">0</div>
                <div class="label">Total Tonase Plan</div>
            </div>
            <div class="kpi-card achievement">
                <div class="value" id="kpi-tonase-achievement">0%</div>
                <div class="label">Pencapaian Tonase</div>
            </div>
        </section>

        <section class="card">
            <h2>Input Data Hari Ini</h2>
            <table class="planning-table" id="planning-table">
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Ekspedisi</th>
                        <th>DN</th>
                        <th>Tanggal</th>
                        <th>Jam</th>
                        <th>Realisasi</th>
                        <th>New Plan</th>
                        <th>Tonase Planing</th>
                        <th>Tonase Real</th>
                        <th>Status</th>
                        <th>Hapus</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    </tbody>
                <tfoot>
                    <tr>
                        <td colspan="5"><strong>Total</strong></td>
                        <td id="total-realisasi"><strong>0</strong></td>
                        <td id="total-newplan"><strong>0</strong></td>
                        <td id="total-ton-plan"><strong>0</strong></td>
                        <td id="total-ton-real"><strong>0</strong></td>
                        <td colspan="2"></td>
                    </tr>
                    <tr class="calc-row">
                        <td colspan="7"><strong>Selisih (Real - Plan)</strong></td>
                        <td id="total-ton-variance" colspan="2"><strong>0.000</strong></td>
                        <td colspan="2"></td>
                    </tr>
                    <tr class="calc-row">
                        <td colspan="7"><strong>Pencapaian %</strong></td>
                        <td id="total-ton-achievement" colspan="2"><strong>0.0%</strong></td>
                         <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>
            <div class="action-buttons">
                <button id="btn-add-row">+ Tambah Baris</button>
                <button id="btn-save">Simpan ke Firebase</button>
            </div>
        </section>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBVh196kMr9FkKwcRgeU-5VSjcXswjspaY",
            authDomain: "report-dco.firebaseapp.com",
            projectId: "report-dco",
            storageBucket: "report-dco.appspot.com",
            messagingSenderId: "179743573823",
            appId: "1:179743573823:web:510cbd12b5d54f8727f58a",
            measurementId: "G-KF1KK2VFL5"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            console.log("Firebase berhasil diinisialisasi.");

            const tableBody = document.getElementById('table-body');
            const planningTable = document.getElementById('planning-table');
            const reportDateElement = document.getElementById('report-date');
            
            const getDocumentIdForToday = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const docId = getDocumentIdForToday();
            const docRef = doc(db, "planning_reports", docId);

            function createRowHtml(rowData) {
                const status = rowData.status || 'Muat';
                return `
                    <tr>
                        <td class="customer" contenteditable="true">${rowData.customer}</td>
                        <td class="ekspedisi-cell" contenteditable="true">${rowData.ekspedisi}</td>
                        <td class="dn-cell" contenteditable="true">${rowData.dn}</td>
                        <td class="date-cell" contenteditable="true">${rowData.tanggal}</td>
                        <td class="time-cell" contenteditable="true">${rowData.jam}</td>
                        <td class="data-cell realisasi" contenteditable="true">${rowData.realisasi}</td>
                        <td class="data-cell new-plan" contenteditable="true">${rowData.newPlan}</td>
                        <td class="data-cell ton-plan" contenteditable="true">${rowData.tonasePlan}</td>
                        <td class="data-cell ton-real" contenteditable="true">${rowData.tonaseReal}</td>
                        <td>
                            <select class="status-select">
                                <option value="Muat" ${status === 'Muat' ? 'selected' : ''}>Muat</option>
                                <option value="OTW Costumer" ${status === 'OTW Costumer' ? 'selected' : ''}>OTW Costumer</option>
                            </select>
                        </td>
                        <td><button class="btn-delete">Hapus</button></td>
                    </tr>
                `;
            }

            function updateStatusColor(selectElement) {
                selectElement.classList.remove('status-muat', 'status-otw');
                if (selectElement.value === 'Muat') {
                    selectElement.classList.add('status-muat');
                } else if (selectElement.value === 'OTW Costumer') {
                    selectElement.classList.add('status-otw');
                }
            }

            function recalculateTotals() {
                let totalRealisasi = 0, totalNewPlan = 0, totalTonPlan = 0, totalTonReal = 0;
                const toNumber = (text) => parseFloat(text.trim().replace(',', '.')) || 0;
                tableBody.querySelectorAll('.realisasi').forEach(cell => totalRealisasi += toNumber(cell.innerText));
                tableBody.querySelectorAll('.new-plan').forEach(cell => totalNewPlan += toNumber(cell.innerText));
                tableBody.querySelectorAll('.ton-plan').forEach(cell => totalTonPlan += toNumber(cell.innerText));
                tableBody.querySelectorAll('.ton-real').forEach(cell => totalTonReal += toNumber(cell.innerText));
                const variance = totalTonReal - totalTonPlan;
                const achievement = (totalTonPlan > 0) ? (totalTonReal / totalTonPlan) * 100 : 0;
                document.getElementById('total-realisasi').innerHTML = `<strong>${totalRealisasi}</strong>`;
                document.getElementById('total-newplan').innerHTML = `<strong>${totalNewPlan}</strong>`;
                document.getElementById('total-ton-plan').innerHTML = `<strong>${totalTonPlan.toFixed(3)}</strong>`;
                document.getElementById('total-ton-real').innerHTML = `<strong>${totalTonReal.toFixed(3)}</strong>`;
                document.getElementById('total-ton-variance').innerHTML = `<strong>${variance.toFixed(3)}</strong>`;
                document.getElementById('total-ton-achievement').innerHTML = `<strong>${achievement.toFixed(1)}%</strong>`;
                document.getElementById('kpi-total-realisasi').innerText = totalRealisasi;
                document.getElementById('kpi-total-newplan').innerText = totalNewPlan;
                document.getElementById('kpi-total-tonplan').innerText = totalTonPlan.toFixed(3);
                document.getElementById('kpi-tonase-achievement').innerText = `${achievement.toFixed(1)}%`;
            }
            
            document.getElementById('btn-add-row').addEventListener('click', () => {
                const now = new Date();
                const date = String(now.getDate()).padStart(2, '0');
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const year = now.getFullYear();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const newRowData = {
                    customer: 'Customer Baru', ekspedisi: 'Nama Ekspedisi', dn: 'Masukkan DN',
                    tanggal: `${date}/${month}/${year}`, jam: `${hours}:${minutes}`,
                    realisasi: '0', newPlan: '0', tonasePlan: '0.0', tonaseReal: '0.0', status: 'Muat'
                };
                tableBody.insertAdjacentHTML('beforeend', createRowHtml(newRowData));
                const newSelect = tableBody.querySelector('tr:last-child .status-select');
                updateStatusColor(newSelect);
            });

            planningTable.addEventListener('click', function(event) {
                if (event.target.classList.contains('btn-delete')) {
                    if (confirm('Apakah Anda yakin ingin menghapus baris ini?')) {
                        event.target.closest('tr').remove();
                        recalculateTotals();
                    }
                }
            });
            planningTable.addEventListener('input', recalculateTotals);
            planningTable.addEventListener('change', function(event) {
                if (event.target.classList.contains('status-select')) {
                    updateStatusColor(event.target);
                }
            });

            const saveButton = document.getElementById('btn-save');
            saveButton.addEventListener('click', async () => {
                const dataToSave = { rows: [], reportDate: reportDateElement.innerText };
                tableBody.querySelectorAll('tr').forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const rowData = {
                        customer: cells[0].innerText, ekspedisi: cells[1].innerText, dn: cells[2].innerText,
                        tanggal: cells[3].innerText, jam: cells[4].innerText, realisasi: cells[5].innerText,
                        newPlan: cells[6].innerText, tonasePlan: cells[7].innerText, tonaseReal: cells[8].innerText,
                        status: cells[9].querySelector('.status-select').value
                    };
                    dataToSave.rows.push(rowData);
                });
                try {
                    saveButton.innerText = "Menyimpan...";
                    saveButton.disabled = true;
                    await setDoc(docRef, dataToSave);
                    alert('Data berhasil disimpan ke Firebase!');
                } catch (error) {
                    console.error("Error saving document: ", error);
                    alert('Gagal menyimpan data. Pesan error: ' + error.message);
                } finally {
                    saveButton.innerText = "Simpan ke Firebase";
                    saveButton.disabled = false;
                }
            });

            function loadCurrentDayData(data) {
                tableBody.innerHTML = '';
                const defaultDate = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                if (data && data.rows && data.rows.length > 0) {
                    data.rows.forEach(rowDataAsObject => {
                        tableBody.insertAdjacentHTML('beforeend', createRowHtml(rowDataAsObject));
                    });
                    reportDateElement.innerText = data.reportDate || defaultDate;
                } else {
                    const initialData = [{
                        customer: 'Contoh Customer', ekspedisi: 'Contoh Ekspedisi', dn: 'DN-000',
                        tanggal: new Date().toLocaleDateString('id-ID').replace(/\./g, '/'), jam: '00:00',
                        realisasi: '0', newPlan: '1', tonasePlan: '10.0', tonaseReal: '0.0', status: 'Muat'
                    }];
                    initialData.forEach(rowDataAsObject => tableBody.insertAdjacentHTML('beforeend', createRowHtml(rowDataAsObject)));
                    reportDateElement.innerText = defaultDate;
                }
                tableBody.querySelectorAll('.status-select').forEach(updateStatusColor);
                recalculateTotals();
            }

            onSnapshot(docRef, (doc) => {
                console.log("Menerima pembaruan data HARI INI dari Firebase...");
                loadCurrentDayData(doc.data());
            }, (error) => {
                console.error("Gagal memuat data hari ini dari Firebase: ", error);
                alert("Tidak dapat terhubung ke database. Memuat data default untuk hari ini.");
                loadCurrentDayData(null);
            });

        } catch (error) {
            console.error("Gagal menginisialisasi Firebase: ", error);
            alert("Terjadi kesalahan fatal saat menghubungkan ke Firebase. Error: " + error.message);
        }
    </script>
</body>
</html>