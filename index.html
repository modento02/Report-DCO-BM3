<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analisis Data</title>
    <!-- Tailwind CSS CDN untuk styling yang responsif dan modern -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter untuk tipografi yang bersih -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js untuk membuat grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS (xlsx.full.min.js) untuk membaca file Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 flex h-screen">

    <!-- Konten Utama -->
    <div class="flex-1 p-8 overflow-y-auto">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Analisis Excel</h2>

        <!-- Tampilan Analisis Excel -->
        <div id="analysis-view" class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Analisis Dokumen Excel</h3>
            <div class="mb-6 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors">
                <p class="text-gray-500 mb-2">Unggah tiga file Excel untuk membandingkan data</p>
                <div class="flex flex-col md:flex-row justify-center items-center gap-4">
                    <label for="excel-file-1" class="cursor-pointer bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200">
                        Pilih File 1
                        <input type="file" id="excel-file-1" class="hidden" accept=".xlsx, .xls">
                    </label>
                    <label for="excel-file-2" class="cursor-pointer bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200">
                        Pilih File 2
                        <input type="file" id="excel-file-2" class="hidden" accept=".xlsx, .xls">
                    </label>
                    <label for="excel-file-3" class="cursor-pointer bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200">
                        Pilih File 3
                        <input type="file" id="excel-file-3" class="hidden" accept=".xlsx, .xls">
                    </label>
                </div>
                <div class="mt-4 text-sm text-gray-500" id="file-names">Belum ada file yang diunggah.</div>
                <button onclick="handleInitialAnalysis()" class="mt-4 bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                    Lanjutkan ke Analisis
                </button>
            </div>
            
            <!-- Tampilan untuk Memilih Kolom -->
            <div id="column-selection-view" class="bg-white p-6 rounded-lg shadow-md hidden">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Pilih Kolom untuk Analisis</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="label-column-select" class="block text-sm font-medium text-gray-700">Kolom untuk Label (X-Axis)</label>
                        <select id="label-column-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <!-- Opsi akan diisi oleh JavaScript -->
                        </select>
                    </div>
                    <div>
                        <label for="value-column-select" class="block text-sm font-medium text-gray-700">Kolom untuk Nilai (Y-Axis)</label>
                        <select id="value-column-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <!-- Opsi akan diisi oleh JavaScript -->
                        </select>
                    </div>
                </div>
                <button onclick="analyzeData()" class="mt-4 bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors">
                    Mulai Analisis
                </button>
            </div>

            <!-- Hasil Analisis dan Grafik -->
            <div id="analysis-results" class="mt-8 hidden">
                <h4 class="text-2xl font-semibold text-gray-800 mb-6">Hasil Analisis</h4>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Grafik Batang -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <h5 class="text-lg font-medium text-gray-700 mb-2">Grafik Batang</h5>
                        <canvas id="barChart"></canvas>
                    </div>
                    <!-- Grafik Garis -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <h5 class="text-lg font-medium text-gray-700 mb-2">Grafik Garis</h5>
                        <canvas id="lineChart"></canvas>
                    </div>
                    <!-- Grafik Pie -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner">
                        <h5 class="text-lg font-medium text-gray-700 mb-2">Grafik Pie</h5>
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Pesan Kustom -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-semibold text-gray-900 mb-4" id="modal-message-title">Peringatan</h3>
            <p class="text-gray-600 mb-6" id="modal-message-content">Ini adalah pesan default.</p>
            <div class="flex justify-end gap-2">
                <button onclick="closeCustomModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors">OK</button>
            </div>
        </div>
    </div>


    <!-- Skrip JavaScript -->
    <script>
        // Mendapatkan elemen-elemen DOM
        const analysisResultsDiv = document.getElementById('analysis-results');
        const excelFile1Input = document.getElementById('excel-file-1');
        const excelFile2Input = document.getElementById('excel-file-2');
        const excelFile3Input = document.getElementById('excel-file-3');
        const fileNamesDiv = document.getElementById('file-names');
        const customModal = document.getElementById('custom-modal');
        const modalMessageTitle = document.getElementById('modal-message-title');
        const modalMessageContent = document.getElementById('modal-message-content');
        const columnSelectionView = document.getElementById('column-selection-view');
        const labelColumnSelect = document.getElementById('label-column-select');
        const valueColumnSelect = document.getElementById('value-column-select');

        
        let file1Data = null;
        let file2Data = null;
        let file3Data = null;
        let commonHeaders = [];
        let myCharts = {}; // Objek untuk menyimpan instance chart

        // Fungsi untuk menampilkan modal pesan kustom
        function showCustomModal(title, message) {
            modalMessageTitle.textContent = title;
            modalMessageContent.textContent = message;
            customModal.classList.remove('hidden');
        }

        // Fungsi untuk menutup modal pesan kustom
        function closeCustomModal() {
            customModal.classList.add('hidden');
        }

        // Fungsi untuk mereset UI
        function resetUI() {
            analysisResultsDiv.classList.add('hidden');
            columnSelectionView.classList.add('hidden');
            labelColumnSelect.innerHTML = '';
            valueColumnSelect.innerHTML = '';
            // Hapus chart yang sudah ada agar tidak tumpang tindih
            for (const chartId in myCharts) {
                if (myCharts[chartId]) {
                    myCharts[chartId].destroy();
                }
            }
            myCharts = {};
        }


        // Listener untuk file input Excel
        excelFile1Input.addEventListener('change', (e) => {
            handleFileChange(e, 1);
            resetUI();
        });
        excelFile2Input.addEventListener('change', (e) => {
            handleFileChange(e, 2);
            resetUI();
        });
        excelFile3Input.addEventListener('change', (e) => {
            handleFileChange(e, 3);
            resetUI();
        });

        // Fungsi untuk menangani perubahan file
        function handleFileChange(e, fileNumber) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (fileNumber === 1) {
                    file1Data = json;
                } else if (fileNumber === 2) {
                    file2Data = json;
                } else {
                    file3Data = json;
                }
                updateFileNames();
            };
            reader.readAsArrayBuffer(file);
        }

        // Memperbarui nama file yang diunggah di UI
        function updateFileNames() {
            const fileName1 = excelFile1Input.files[0] ? excelFile1Input.files[0].name : 'Belum ada file 1';
            const fileName2 = excelFile2Input.files[0] ? excelFile2Input.files[0].name : 'Belum ada file 2';
            const fileName3 = excelFile3Input.files[0] ? excelFile3Input.files[0].name : 'Belum ada file 3';
            fileNamesDiv.textContent = `File 1: ${fileName1}, File 2: ${fileName2}, File 3: ${fileName3}`;
        }

        // Fungsi untuk memulai proses analisis setelah file diunggah
        function handleInitialAnalysis() {
            if (!file1Data || !file2Data || !file3Data) {
                showCustomModal('Peringatan', 'Mohon unggah ketiga file Excel terlebih dahulu!');
                return;
            }

            const header1 = file1Data[0] || [];
            const header2 = file2Data[0] || [];
            const header3 = file3Data[0] || [];

            // Temukan header yang sama di ketiga file
            commonHeaders = header1.filter(h => header2.includes(h) && header3.includes(h));

            if (commonHeaders.length === 0) {
                 showCustomModal('Peringatan', 'Tidak ada kolom yang sama di ketiga file untuk dibandingkan.');
                 return;
            }

            // Isi dropdown dengan header yang sama
            labelColumnSelect.innerHTML = '';
            valueColumnSelect.innerHTML = '';
            commonHeaders.forEach(header => {
                const optionLabel = document.createElement('option');
                optionLabel.value = header;
                optionLabel.textContent = header;
                labelColumnSelect.appendChild(optionLabel);

                const optionValue = document.createElement('option');
                optionValue.value = header;
                optionValue.textContent = header;
                valueColumnSelect.appendChild(optionValue);
            });

            columnSelectionView.classList.remove('hidden');
        }

        // Fungsi utama untuk analisis data setelah kolom dipilih
        function analyzeData() {
            const labelColumn = labelColumnSelect.value;
            const valueColumn = valueColumnSelect.value;

            if (!labelColumn || !valueColumn) {
                showCustomModal('Peringatan', 'Mohon pilih kolom untuk label dan nilai.');
                return;
            }

            const analysisResults = [];
            const labels = [];
            const data1 = [];
            const data2 = [];
            const data3 = [];

            // Asumsi: data adalah array of array, dan baris pertama adalah header
            const header1 = file1Data[0];
            const header2 = file2Data[0];
            const header3 = file3Data[0];
            
            const labelColumnIndex1 = header1.indexOf(labelColumn);
            const valueColumnIndex1 = header1.indexOf(valueColumn);
            const labelColumnIndex2 = header2.indexOf(labelColumn);
            const valueColumnIndex2 = header2.indexOf(valueColumn);
            const labelColumnIndex3 = header3.indexOf(labelColumn);
            const valueColumnIndex3 = header3.indexOf(valueColumn);

            const maxRows = Math.max(file1Data.length, file2Data.length, file3Data.length);
            for (let i = 1; i < maxRows; i++) {
                const row1 = file1Data[i] || [];
                const row2 = file2Data[i] || [];
                const row3 = file3Data[i] || [];

                const label = row1[labelColumnIndex1] || row2[labelColumnIndex2] || row3[labelColumnIndex3] || `Baris ${i}`;
                const val1 = parseFloat(row1[valueColumnIndex1]) || 0;
                const val2 = parseFloat(row2[valueColumnIndex2]) || 0;
                const val3 = parseFloat(row3[valueColumnIndex3]) || 0;
                
                labels.push(label);
                data1.push(val1);
                data2.push(val2);
                data3.push(val3);
                analysisResults.push({ label, value1: val1, value2: val2, value3: val3 });
            }
            
            console.log('Hasil Analisis:', analysisResults);

            // Tampilkan hasil analisis dan grafik
            analysisResultsDiv.classList.remove('hidden');
            createCharts(labels, data1, data2, data3);
        }

        // Fungsi untuk membuat grafik
        function createCharts(labels, data1, data2, data3) {
            // Hapus chart yang sudah ada agar tidak tumpang tindih
            for (const chartId in myCharts) {
                if (myCharts[chartId]) {
                    myCharts[chartId].destroy();
                }
            }

            const ctxBar = document.getElementById('barChart').getContext('2d');
            myCharts.bar = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Data File 1',
                        data: data1,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Data File 2',
                        data: data2,
                        backgroundColor: 'rgba(16, 185, 129, 0.7)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Data File 3',
                        data: data3,
                        backgroundColor: 'rgba(234, 179, 8, 0.7)',
                        borderColor: 'rgba(234, 179, 8, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            const ctxLine = document.getElementById('lineChart').getContext('2d');
            myCharts.line = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Data File 1',
                        data: data1,
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        fill: true,
                        tension: 0.3
                    }, {
                        label: 'Data File 2',
                        data: data2,
                        borderColor: 'rgba(16, 185, 129, 1)',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        fill: true,
                        tension: 0.3
                    }, {
                        label: 'Data File 3',
                        data: data3,
                        borderColor: 'rgba(234, 179, 8, 1)',
                        backgroundColor: 'rgba(234, 179, 8, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            const ctxPie = document.getElementById('pieChart').getContext('2d');
            // Untuk pie chart, kita akan menampilkan total selisih dari ketiga file
            const totalData1 = data1.reduce((sum, val) => sum + val, 0);
            const totalData2 = data2.reduce((sum, val) => sum + val, 0);
            const totalData3 = data3.reduce((sum, val) => sum + val, 0);
            const totalAll = totalData1 + totalData2 + totalData3;

            const pieData = [
                ((totalData1 / totalAll) * 100).toFixed(2),
                ((totalData2 / totalAll) * 100).toFixed(2),
                ((totalData3 / totalAll) * 100).toFixed(2)
            ];

            myCharts.pie = new Chart(ctxPie, {
                type: 'pie',
                data: {
                    labels: ['File 1', 'File 2', 'File 3'],
                    datasets: [{
                        label: 'Persentase Total Data',
                        data: pieData,
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.7)',
                            'rgba(16, 185, 129, 0.7)',
                            'rgba(234, 179, 8, 0.7)'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }
        
        // Inisialisasi tampilan awal
        window.onload = () => {
             // Tidak ada lagi tabel yang perlu di-render, cukup tampilkan tampilan analisis.
        };
    </script>
</body>
</html>
